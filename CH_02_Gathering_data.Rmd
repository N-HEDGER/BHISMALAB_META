---
title: "Gathering data"
output:
  html_document: 
    keep_md: yes
---
![](https://images2.imgbox.com/24/71/0KH49y9V_o.png "Title")
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Creating a dataset.

In this chapter, we will focus on the nuts and bolts of computing effect sizes for meta analyses. In my opinion, this is a topic that is not given the attention it deserves in meta-analysis textbooks. Empirical papers can vary wildly in terms of the information that they report and so a number of strategies can be required to estimate an effect size.

## Cohen's d

This chapter will focus soley on Cohen's d, since it is by far the most commonly used effect size. In principle though, the steps we follow will be more or less the same regardless of the effect size we wish to compute.

Cohen's d actually can actually be defined in a number of ways, but the Generic formula is:

(Mean 1 - Mean 2)/ SD

Cohens d therefore represents the difference between two means in standard deviation units. You can find an interactive visualisation of Cohen's d and its relationship with other metrics [here](http://rpsychologist.com/d3/cohend/).

## Standardisers for d

The denominator of the equation (SD) as I have presented it above is ambiguous - a standard deviation is referred to - but there are actually a number of possible standard deviations I could be refering to. We could use:

1. The SD of Group/Condition 1
2. The SD of Group/Condition 2
3. The SD of the difference between Group/Condition 1 and Group/Condition 2.
4. The pooled SD of Group/Condition 1 and Group/Condition 2.

In fact, these are all perfectly legitimate options. The consequences of using each standardiser can be a complex issue and this is all described excellently in [This](https://www.frontiersin.org/articles/10.3389/fpsyg.2013.00863/full) paper by Lakens (2013).

In practice, all we really need to ensure is that we:

1. Compute the mean difference standardised by some standard deviation.
2. Are clear about which standardiser we used.
3. Are consistent in using the same standardiser for each effect in our analysis.

Therefore *clarity* and *consistency* are much more important than the specific choice of standardiser itself.

If we are *consistent*, then all of our effect sizes will be comparable to one another.
If we are *clear* then this will allow researchers to interpret our results correctly and make any conversions to other forms of Cohen's d, if they want to compare the results to previously published papers.

It **will not do** to simply report that you 'calculated Cohen's d', since, as we have seen, d can be defined and operationalized in a number of different ways.

## Cohen's dz

In the repeated measures design, it is often desirable to use the *standard deviation of the difference scores* (option 3 described above) as the standardiser, creating a statistic often referred to as 'Cohens dz'. This is because the information most reliably reported in experimental papers tends to be a t, or p statistic - and dz can be easily calculated from just the t/p and N. By contrast, you are less likely to find tables of means and standard deviations in every paper - which makes options 1, 2 and 4 less reliable. Of course, you may want to root through your candidate set of papers and base your choice of standardiser on what information is most frequently reported. 


## Scenario 1: dz from t or p value and N. 

In this first scenario, we will be computing dz from the p or t value and N. This is the best case scenario, where everything we need is reported.  

First, let's make up some example repeated measures data.
```{r}
# Import metafor library
library(metafor)

# Create dummy data values for two conditions (repeated measures) 
set.seed(10)
Condition1=rnorm(20,6,5)
Condition2=rnorm(20,5,7)

# Compute t test to get t and p value
test=t.test(Condition1,Condition2,paired=TRUE)
```

The output of the t test object will give us information similar to that reported in an empirical paper.

```{r}
test

```

In a published paper, this would typically be written as: "A paired t-test detected significantly higher scores in condition 1 than condition 2 (t(19) = 3.54, p=.002".

Now let's define a function for computing Cohen's dz, based on the t value and p value. We will also define a function that computes dz based on the mean differences and SD of the difference scores, so you can convince yourself that all methods return the same results. Each function returns [1] dz, [2] the standard error of dz, [3] the lower bound of the confidence interval and [4] the upper bound of the confidence interval.

```{r}
# Method 1: Define a function for converting from p value and N to Cohen's dz and 95% CI's
ptoDr=function(p,N,r){
T=qt(p/2,N-1)
D=T/sqrt(N)
Da=D*sqrt(2*(1-r))
Da2=sqrt(Da^2)
SE=sqrt(1/N+D^2/(2*N))*sqrt(2*(1-r))
CIp=Da2+(SE*1.96)
CIn=Da2-(SE*1.96)
DSE=c(Da2,SE,CIn,CIp)}

# Method 2: Define a function for converting from t value and N to Cohen's dz and 95% CI's
TtoDr=function(t,N,r)
{D=t/sqrt(N)
 Dp=sqrt(D^2)
 Dp2=Dp*sqrt(2*(1-r))
 SE=sqrt((1/N)+(Dp^2)/(2*N))*sqrt(2*(1-r))
 CIp=Dp2+(SE*1.96)
 CIn=Dp2-(SE*1.96)
 DSE=c(Dp2,SE,CIn,CIp)}

# Method 3: Define a function for converting from original condition data to Cohen's dz and 95% CI's
CtoD=function(G1,G2){
# Mean difference
Mdiff=mean(G1)-mean(G2)
N=length(G1)
# Standard deviation of the difference scores. 
SDdiff=sd(G1-G2)
D=Mdiff/SDdiff
SE=sqrt((1/N)+(D^2)/(2*N))
CIp=D+(SE*1.96)
CIn=D-(SE*1.96)
DSE=c(D,SE,CIn,CIp)}

result1=ptoDr(test$p.value,20,0.5)
result2=TtoDr(as.numeric(test$statistic),20,0.5)
result3=CtoD(Condition1,Condition2)

result1
result2
result3

```

Great, now lets define this as our first effect size to be included in our model.

```{r}
Effect1=result1
```

## Scenario 2: No exact p value is reported.

In this next scenario, we are faced with a very common problem, which is that the author has reported that an effect was 'significant', but has not reported the exact p value. For instance: 

"A paired t-test detected significantly higher scores in condition 1 than condition N =50 p<.050".

I am not aware of any formal convention for how to approach this scenario, but if in doubt, I think that the best strategy is to be conservative. Of course, the most conservative possible interpretation of p<.050 is that p =.049 and so this should form the basis of our effect size calculation.


```{r}
result2=ptoDr(0.49,20,0.5)
```


## Scenario 3: A 'non significant' effect


```{r,echo=FALSE}


library(shiny)
library(ggplot2)
library(metafor)


old_theme1 <- theme_bw()


shinyServer(function(input, output) {  
  
  dataset <- function() {
    data.frame(cbind(c(input$Mean1,input$Mean2),c(input$SE1,input$SE2),c(input$Mean1+(1.96*input$SE1),input$Mean2+(1.96*input$SE2)),c(input$Mean1-(1.96*input$SE1),input$Mean2-(1.96*input$SE2)),c(2,1)))
    
  }
  
  
  MOD=function(){
    t=dataset()
    t=data.frame(t)
    colnames(t)=c("a","b")
    d=rma(yi=a,sei=b,data=t)
    return(d)
  }
    
  
#   MOD=function(){
#   t=data.frame(cbind(c(input$Mean1,input$Mean2),c(input$SE1,input$SE2),c(input$Mean1+(1.96*input$SE1),input$Mean2+(1.96*input$SE1)),c(input$Mean1-(1.96*input$SE1),input$Mean2-(1.96*input$SE1)),1:2))
#   j=rma(t,yi=X1,sei=X2)
#   return(j)
#   }
  
   output$plot <- renderPlot({
     
     if (input$showoutcome)
     x=ggplot(dataset(), aes(X5,X1)) +geom_point(size=4)+geom_point(aes(x=0),y=as.numeric(MOD()$b),size=9,colour="red",shape=23,fill="red")  +geom_errorbar(aes(ymin=X3, ymax=X4))+geom_errorbar(aes(x=0),ymin=MOD()$ci.lb, ymax=MOD()$ci.ub,colour="red") + geom_hline(aes(yintercept=0),linetype="dashed")+coord_flip()+ylab("Cohen's d")+xlab("Study")+
       scale_y_continuous(limits=c(-3,3),breaks=seq(-3,3,0.5))+scale_x_discrete(limits=c("","",""))
else
  
  x=ggplot(dataset(), aes(X5,X1)) +geom_point(size=4)+geom_point(aes(x=0),y=as.numeric(MOD()$b),size=9,colour="white",shape=23,fill="white")  +geom_errorbar(aes(ymin=X3, ymax=X4))+geom_errorbar(aes(x=0),ymin=MOD()$ci.lb, ymax=MOD()$ci.ub,colour="white") + geom_hline(aes(yintercept=0),linetype="dashed")+coord_flip()+ylab("Cohen's d")+xlab("Study")+
       scale_y_continuous(limits=c(-3,3),breaks=seq(-3,3,0.5))+scale_x_discrete(limits=c("","",""))
  
     print(x)})
     
     
#     if (input$bivariate)
#       p=qplot(rnorm(input$sampleSize,0,1),rnorm(input$sampleSize,0,1))+scale_x_continuous(limits=c(-4,4),breaks=seq(-4,4,1))+scale_y_continuous(limits=c(-4,4),breaks=seq(-4,4,1))
#     print(p)
#   },height=300,width=300)
#   
  
  
  
  
  output$text1 <- renderText({ 
  
#         MOD=rma(yi=X1,sei=X2,data=dataset())
    if (input$showoutcome)    
    paste("The random effects model indicates pooled effect size is", MOD()$b)
    
  })
     output$text2 <- renderText({ 
#         MOD=rma(yi=X1,sei=X2,data=dataset())
       if (input$showoutcome)        
       paste("The 95% confidence interval ranges from",
             MOD()$ci.lb, "to", MOD()$ci.ub)
     
   })
#   
   output$text3 <- renderText({ 
     if (input$showoutcome)
    paste("The probability of obtaining the results under the null hypothesis is", MOD()$pval)
#     
   })
  
  
})




library(shiny)
library(ggplot2)
library(metafor)

shinyUI(pageWithSidebar(
  
  headerPanel("Meta two"),
  sidebarPanel(
    helpText("Use the sliders to vary the effect size and standard error of two studies."),
    br(),
    br(),
    helpText("Enter the effect size for study 1."),
    sliderInput('Mean1', 'Effect size 1', min=-1.5, max=1.5,
                value=-0.5,step=0.1),
    
    helpText("Enter the standard error for study 1."),
    
    sliderInput('SE1', 'Standard Error 1', min=0.05, max=0.5,
                value=0.2,step=0.01),
    
    helpText("Enter the effect size for study 2."),
    
    sliderInput('Mean2', 'Effect size 2', min=-1.5, max=1.5,
                value=1,step=0.1),
    
    helpText("Enter the standard error for study 2."),
    
    sliderInput('SE2', 'Standard Error 2', min=0.05, max=0.5,
                value=0.2,step=0.01),
  
  
    br(),
    br(),
    br(),
    br(),
  checkboxInput('showoutcome', 'Show Outcome?',TRUE),
    
  helpText("Turn this on and off to display the outcome of the meta analysis")),
  
  mainPanel(
    h1("Meta analysis for two studies"),
    helpText("This excercise will allow you to observe how the magnitude and precision of two studies relate to the pooled effect size computed via meta-analysis (in red)"),
    br(),
    helpText("Use the checkbox to turn the outcome on and off. See if you can estimate the magnitude and precision of the pooled effect based on your input"),
     plotOutput('plot'),
     br(),
    textOutput('text1'),
     br(),
     textOutput('text2'),
      br(),
      textOutput('text3')
  )))


```



